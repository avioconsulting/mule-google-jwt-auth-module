<?xml version="1.0" encoding="UTF-8"?>
<module name="Mule JWT Auth Module"
        category="PREMIUM"
        xmlns="http://www.mulesoft.org/schema/mule/module"
        xmlns:http="http://www.mulesoft.org/schema/mule/http"
        xmlns:os="http://www.mulesoft.org/schema/mule/os"
        xmlns:mule="http://www.mulesoft.org/schema/mule/core"
        xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
        xmlns:java="http://www.mulesoft.org/schema/mule/java"
        xmlns:jwt-auth="http://www.mulesoft.org/schema/mule/module-jwt-auth"        
        xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/module http://www.mulesoft.org/schema/mule/module/current/mule-module.xsd 
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd 
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd 
http://www.mulesoft.org/schema/mule/module-jwt-auth http://www.mulesoft.org/schema/mule/module-jwt-auth/current/mule-module-jwt-auth.xsd">

	<property name="privateKeyId" type="string" displayName="Private Key Id" doc:description="Private Key Id"
			  order="1"/>
	<property name="privateKey" type="string" displayName="Private Key" doc:description="RSA Private Key"
			  order="2" />
	<property name="issuer" type="string" displayName="Issuer" doc:description="Email of user issuing authorization"
			  example="test-user@gmail.com" order="3" />
	
	<operation name="get-google-access-token" doc:description="Generate a signed JWT to send to Google and receive an access token">
	
		<parameters>
			<parameter name="user" type="string" displayName="User" use="OPTIONAL" doc:description="Email of user performing operation"
              example="test-user@gmail.com" order="1" />
            <parameter name="scopes" type="string" displayName="Scopes" doc:description="Space delimited list of permission scopes"
              example="https://www.googleapis.com/auth/drive" order="2" />
			<parameter name="objectStoreConfig" type="string" displayName="Object Store Config name"
              example="object-store" order="3" />
		</parameters>
		
		<body>
			<mule:logger level="INFO" doc:name="Log START" doc:id="6cdf2ed1-d491-45a5-9fcc-a25ea6170918" message="Start JSON Web Token generation" category="com.avioconsulting.modules.jwt.auth"/>
			<java:invoke-static doc:name="Create JWT" doc:id="bd444c83-ee1a-40ea-b45d-2f924cdb40b1" class="com.avioconsulting.utils.authUtils" method="createJWT(String, String, String, String, String, String)" target="googleJWT">
			<java:args ><![CDATA[#[{
	arg0: vars.privateKeyId,
	arg1: vars.privateKey,
	arg2: vars.issuer,
	arg3: vars.user default "",
	arg4: vars.scopes,
	arg5: "https://oauth2.googleapis.com/token"
}]]]></java:args>
		</java:invoke-static>
		<mule:logger level="DEBUG" doc:name="Log Java code executed" doc:id="1777d2f8-fba8-486a-bea9-40d170026857" message="JWT generation Java code execution complete" category="com.avioconsulting.modules.jwt.auth"/>
			<mule:choice doc:name="Choice" doc:id="769f4ed3-1979-420d-97f5-abe3f3a798d9" >
			<mule:when expression='#[vars.googleJWT contains("ERROR:")]'>
				<mule:logger level="ERROR" doc:name="Log error" doc:id="1da71b81-7a39-4ee5-98af-99cc8ef2c625" message="An error ocurred during Java code execution, raising error" category="com.avioconsulting.modules.jwt.auth"/>
				<mule:raise-error doc:name="Raise error" doc:id="9e380126-0c7c-4a0e-bcea-32d6031266b6" type="MULE-JWT-AUTH:JWT_GENERATION" description="#['An error occurred when generating the JSON Web Token to send to Google\'s OAuth service. $(vars.googleJWT)']"/>
			</mule:when>
			<mule:otherwise >
				<mule:logger level="INFO" doc:name="Log JWT send" doc:id="b52626dd-8c9f-4c21-9182-753cf19eb729" category="com.avioconsulting.modules.jwt.auth" message="Send JWT to Google for authorization"/>
				<http:request method="POST" doc:name="Request Token from Google" doc:id="6cc93bc3-5a85-4442-8cd1-f30de2303df3" url="https://oauth2.googleapis.com/token" >
			<http:query-params><![CDATA[#[output application/java
---
{
	grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
	assertion: vars.googleJWT
	
}]]]></http:query-params>
		</http:request>
			</mule:otherwise>
		</mule:choice>
		<mule:logger level="DEBUG" doc:name="Log Google response" doc:id="52d6406a-dbe1-42e3-a44b-102c9852e50d" message="Received response from Google" category="com.avioconsulting.modules.jwt.auth"/>
		<ee:transform doc:name="Clean and format recieved token" doc:id="82a18a48-5c2f-41fc-88c7-6ba01ded09d8" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
payload.access_token]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<mule:logger level="INFO" doc:name="Log object store" doc:id="683c3d6f-1fc8-4d92-b06b-f5c0342d1cd5" category="com.avioconsulting.modules.jwt.auth" message="Storing Google access token on provided object store"/>
		<os:store doc:name="Store Access Token Response" doc:id="b0dce7d5-41c6-4a64-a160-f8096d1efa28" key="googleToken" objectStore="#[vars.objectStoreConfig]"/>
		</body>
		<output type="any"></output>
	</operation>
</module>